# myylib 项目总结

这个项目一开始是在今年年初，无所事事的时候，想找点事情作，于是决定写这些小玩意。

就是想造造轮子，先是从hex，base编码开始，然后选择了国密标注相关的题材。

大半年过去了，中间有很多其他事情，但每次坐在电脑面前不知道干啥的时候就会打开这个项目，

clone-···->add->commit->push->rm -rf，

到了现在于是算是完成了所谓的六大密码工具：

> 对称加密（SM4_GCM）
> 非对称加密（SM2）
> 单向散列（SM3）
> 消息认证码（SM3_HMAC）
> 数字签名（SM2_ECDSA）
> 伪随机数生成器

其中伪随机数生成器偷了点懒，直接调用了liunx下的/dev/urandom文件，亦或者，SM3_KDF也可以算一种伪随机数生成器吧

## SM3

SM3是国密中与SHA-256同级别的消息散列函数，输入数据，并输出他的256位哈希值。其可以校验消息完整性。

这是本项目最先实现的算法，因为后续的任务经常需要使用SM3提供的功能。

随后基于SM3算法，实现了HMAC函数，通过加入密钥一起散列，可以用于消息认证。

以及基于SM3的密钥导出函数，相当于一个伪随机数发生器，输入种子可以派生出需要长度的字节流。

此外，还写了一个工具，用于计算若干文件的SM3杂凑值，命令就是简单的sm3，可以用来快速获得文件的杂凑值或比较两个文件是否相同

还提供了一个针对SM3不规范使用HMAC功能的长度扩展攻击payload生成工具sm3pump。

## SM4

SM4是国密中对标AES-128的一种对称分组加密算法，其使用128位的密钥与128位的分组长度

本项目中提供了ECB模式，GCM模式和不算很完善的CBC模式加密

ECB模式加密小规模数据时很好用

GCM是一种AEAD加密，其除了提供数据保密外，还提供对保密数据以及附加鉴别数据的消息认证

AEAD算法有很多，项目中选取了GCM这一最常用的算法，也是TLCP协议中推荐的算法。

而CBC模式，由于其使用不当会造成很多安全性问题，所以只是简易提供了一个带xor的块加密函数作为其实现。

## SM2

SM2是国密中对标ECC的非对称加密算法，效率比RSA更优。

因为同为广泛使用的公钥加密体制，SM2经常与RSA作对比，不过从算法的原理来看，SM2公钥加密与ElGamal算法类似，只不过一个基于离散对数困难问题，一个则基于椭圆曲线上的离散对数困难问题；SM2数字签名与ECDSA类似；SM2密钥交换与ECMQV类似（而不是ECDHE）

其是本项目中目前占比最大的部分，其分为四层：

底层是大数计算库，其使用带进位的汇编指令实现，不考虑溢出与取模问题，如两个256位相乘将会得到一个512位整数

上层是有限域的运算，使用针对模数稍加优化的巴雷特模乘实现和蒙哥马利模乘实现，提供了模P有限域和模N有限域下的计算

再上层是椭圆曲线上的点运算，提供了普通实现以及效率较高的蒙哥马利实现。有一说一从设计层面说，蒙哥马利域不应该被引入到这一层，但是蒙哥马利模乘只有在蒙哥马利域上接连计算乘法时才能发挥出优势，所以不得不再这一层引入蒙哥马利域的概念。

顶层则是SM2相关算法的实现，其调用点运算函数和模N有限域下的大数计算函数，实现了密钥管理，数字签名，密钥交换与公钥加密

该部分比开源项目GMSSL 3.0.0有近一倍的效率提升，主要得益于最底层大数运算的高效实现（不过gmssl项目升级之后也提升了不少）。

## 下一步

从README.md中，可以看到还有一些flag没有完成，其中有一些只是当时一时兴起决定想写的，但实际上目前来说没有实现的需求

第一，SM2/SM3/SM4算法的实现还有优化的空间，比如可以利用Intel的SSE或AVX指令集加速运算。

第二，还有一种常见的对称加密算法——序列密码，国密中为ZUC密码还没有实现。之所以如此因为流密码在软件上仿佛完全被分组加密掩盖了光芒，而且GCM模式由于是一种计数器模式，也可以看作将分组密码转换为了流密码。

第三，还有一种常见的非对称加密算法——标识密码，国密中为SM9标识密码。一是，目前来说SM9能干的SM2都能干；二是，SM9的标准要求比起SM2有一些新的内容，而且所使用的椭圆曲线参数也不一样，意味着要从有限域运算重新写起:-(。

不过以上三点归结起来就是：我还没搞清楚:-(。